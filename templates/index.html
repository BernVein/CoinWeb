<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PH Coin Classifier</title>
    <!-- Google Fonts: Inter and JetBrains Mono for modern/monospace look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-main: #0f1117;
            --bg-card: #16181f;
            --bg-card-alt: #1e2128;
            --text-main: #f5f6fa;
            --text-secondary: #b0b3b8;
            --accent: #3dd68c;
            --accent-hover: #2ebd7f;
            --border: #23252b;
            --shadow: 0 4px 24px 0 rgba(0,0,0,0.25);
            --radius: 24px;
            --radius-sm: 16px;
            --transition: all 0.3s cubic-bezier(.4,0,.2,1);
            --font-size-sm: 0.8rem;
            --font-size-base: 0.9rem;
            --font-size-lg: 1rem;
            --font-size-xl: 1.1rem;
        }
        html, body {
            height: 100%;
        }
        body {
            min-height: 100vh;
            background: var(--bg-main);
            color: var(--text-main);
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
        }
        .container {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding: 40px 16px 0 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 42px 32px 32px 32px;
            margin-bottom: 36px;
            width: 100%;
            border: 1.5px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        .upload-container {
            width: 100%;
            min-height: 180px;
            border: 2.5px dashed var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-card-alt);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 26px;
            position: relative;
            overflow: hidden;
        }
        .upload-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(61,214,140,0.03), transparent);
            opacity: 0;
            transition: var(--transition);
        }
        .upload-container:hover::before {
            opacity: 1;
        }
        .upload-container:hover, .upload-container.highlight {
            border-color: var(--accent);
            background: #1e222a;
            transform: translateY(-2px);
        }
        .upload-container i {
            font-size: 3rem;
            color: var(--accent);
            margin-bottom: 16px;
            transition: var(--transition);
        }
        .upload-container:hover i {
            transform: scale(1.1);
        }
        .upload-text {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 4px;
        }
        .upload-hint {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }
        .file-input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }
        #image-preview-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 22px;
            height: 240px;
            background-color: var(--bg-card-alt);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        #image-preview {
            max-width: 100%;
            max-height: 240px;
            border-radius: var(--radius-sm);
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.18);
            display: none;
            background: #23252b;
            object-fit: contain;
            width: auto;
            height: auto;
        }
        .buttons-group {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 14px;
            width: 100%;
            margin-top: 8px;
        }
        @media (min-width: 480px) {
            .buttons-group {
                flex-direction: row;
            }
        }
        .btn {
            background: var(--accent);
            color: #111;
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'Inter', Arial, sans-serif;
            font-size: var(--font-size-base);
            font-weight: 600;
            padding: 14px 0;
            width: 100%;
            max-width: 240px;
            margin: 0;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 8px 0 rgba(61,214,140,0.2);
            letter-spacing: 0.01em;
            position: relative;
            overflow: hidden;
        }
        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: translateX(-100%);
            transition: var(--transition);
        }
        .btn:hover::after {
            transform: translateX(100%);
        }
        .btn:hover, .btn:focus {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px 0 rgba(61,214,140,0.3);
        }
        .btn-secondary {
            background: var(--bg-card-alt);
            color: var(--text-main);
            border: 1.5px solid var(--border);
        }
        .btn-secondary:hover {
            background: #23252b;
            color: var(--accent);
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        .btn-icon {
            max-width: 56px;
            height: 56px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .btn-icon i {
            font-size: 1.3rem;
        }
        .btn-check {
            background-color: var(--accent);
        }
        .btn-check:hover {
            background-color: #54a0ff;
            border-color: #54a0ff;
        }
        .btn-check.btn-disabled {
            background: #23252b;
            color: #666;
            cursor: not-allowed;
            border: 1.5px solid #23252b;
        }
        .btn-disabled {
            background: #23252b;
            color: #666;
            cursor: not-allowed;
            border: 1.5px solid #23252b;
        }
        .hidden {
            display: none !important;
        }
        .results-container {
            width: 100%;
            animation: fadeIn 0.6s cubic-bezier(.4,0,.2,1);
        }
        .results-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: var(--font-size-xl);
            color: var(--accent);
            font-weight: 700;
            margin-bottom: 20px;
            letter-spacing: 0.01em;
        }
        .result-image-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 22px;
            position: relative;
        }
        #result-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: var(--radius-sm);
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.18);
            background: #23252b;
            object-fit: contain;
            width: auto;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        .result-image-hidden {
            display: none;
        }
        #bounding-box-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            width: 100%;
            height: 100%;
        }
        .bounding-box {
            position: absolute;
            border: 2px solid;
            border-radius: 4px;
            font-size: 10px;
            color: white;
            pointer-events: none;
        }
        .bounding-box.class-1 {
            border-color: #FF6B6B;
        }
        .bounding-box.class-5 {
            border-color: #4ECDC4;
        }
        .bounding-box.class-10 {
            border-color: #FFD166;
        }
        .bounding-box.class-20 {
            border-color: #A78BFA;
        }
        .bounding-box-label {
            background-color: inherit;
            border-radius: 2px;
            padding: 0 4px;
            position: absolute;
            top: -16px;
            left: 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            white-space: nowrap;
        }
        .toggle-switch {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }
        .toggle-switch input[type="checkbox"] {
            height: 0;
            width: 0;
            visibility: hidden;
        }
        .toggle-switch label {
            cursor: pointer;
            text-indent: -9999px;
            width: 40px;
            height: 20px;
            background: var(--bg-card-alt);
            border: 1px solid var(--border);
            display: block;
            border-radius: 100px;
            position: relative;
        }
        .toggle-switch label:after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background: var(--text-secondary);
            border-radius: 90px;
            transition: 0.3s;
        }
        .toggle-switch input:checked + label {
            background: var(--accent);
        }
        .toggle-switch input:checked + label:after {
            left: calc(100% - 2px);
            transform: translateX(-100%);
            background: white;
        }
        .coin-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 0 0 22px 0;
            width: 100%;
        }
        .coin-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            width: 100%;
            margin-bottom: 20px;
        }
        .coin-card {
            background: var(--bg-card-alt);
            border-radius: var(--radius-sm);
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.15);
            padding: 24px 12px 18px 12px;
            text-align: center;
            border: 1.5px solid var(--border);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        .coin-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent);
            transform: scaleX(0);
            transition: var(--transition);
        }
        .coin-card:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 20px 0 rgba(61,214,140,0.15);
            transform: translateY(-2px);
        }
        .coin-card:hover::before {
            transform: scaleX(1);
        }
        .coin-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 6px;
        }
        .peso-sign {
            font-size: 1.1rem;
            vertical-align: super;
        }
        .coin-count {
            display: block;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }
        .total-amount {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            margin: 18px 0 0 0;
            text-align: center;
            padding: 16px 0 0 0;
            color: var(--accent);
            border-top: 1.5px solid var(--border);
            width: 100%;
        }
        .conversion-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1.5px solid var(--border);
        }
        .conversion-item {
            background: var(--bg-card-alt);
            padding: 12px;
            border-radius: var(--radius-sm);
            border: 1.5px solid var(--border);
            transition: var(--transition);
            cursor: pointer;
        }
        .conversion-item:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        .conversion-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        .conversion-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: var(--font-size-base);
            color: var(--accent);
            font-weight: 600;
        }
        .conversion-modal .modal-content {
            max-width: 320px;
        }
        .conversion-details {
            margin: 16px 0;
            padding: 16px;
            background: var(--bg-card-alt);
            border-radius: var(--radius-sm);
            border: 1.5px solid var(--border);
        }
        .conversion-rate {
            font-family: 'JetBrains Mono', monospace;
            font-size: var(--font-size-lg);
            color: var(--accent);
            margin: 8px 0;
        }
        .conversion-example {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-top: 8px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: var(--bg-card);
            padding: 32px;
            border-radius: var(--radius);
            max-width: 90%;
            width: 400px;
            text-align: center;
            border: 1.5px solid var(--border);
            animation: modalFadeIn 0.3s ease-out;
        }
        .modal-icon {
            font-size: 3rem;
            color: var(--accent);
            margin-bottom: 16px;
        }
        .modal-title {
            font-size: var(--font-size-xl);
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-main);
        }
        .modal-message {
            font-size: var(--font-size-base);
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        .modal-btn {
            background: var(--accent);
            color: #111;
            border: none;
            border-radius: var(--radius-sm);
            padding: 12px 24px;
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        .modal-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .footer {
            width: 100%;
            text-align: center;
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            padding: 28px 0 14px 0;
            margin-top: auto;
            background: transparent;
            letter-spacing: 0.01em;
            line-height: 1.6;
        }
        .footer-name {
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 4px;
        }
        .footer-course {
            font-size: var(--font-size-sm);
            opacity: 0.8;
        }
        @media (max-width: 600px) {
            .container {
                max-width: 99vw;
                padding: 18px 2vw 0 2vw;
            }
            .card {
                padding: 14px 4px 12px 4px;
            }
            .coin-group {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .upload-area-hidden {
            display: none !important;
        }
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            cursor: pointer;
        }
        .preview-modal img {
            max-width: 90%;
            max-height: 90vh;
            margin: auto;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            object-fit: contain;
        }
        .preview-modal-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1001;
        }
        .unclassified-message {
            text-align: center;
            color: var(--text-secondary);
            font-size: var(--font-size-base);
            margin: 20px 0;
            padding: 16px;
            background: var(--bg-card-alt);
            border-radius: var(--radius-sm);
            border: 1.5px solid var(--border);
        }
        .results-container.unclassified .coin-group,
        .results-container.unclassified .total-amount,
        .results-container.unclassified .conversion-grid {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card" id="main-card">
            <div class="results-title"><i class="fas fa-coins"></i> Philippine Coin Classifier</div>
            
            <form id="upload-form" action="/" method="post" enctype="multipart/form-data">
                <div id="upload-area" class="{{ 'upload-area-hidden' if coin_counts else '' }}">
                    <label for="coin_image" class="upload-container">
                        <i class="fas fa-coins"></i>
                        <p class="upload-text">Drop image here or click to browse</p>
                        <p class="upload-hint">Supports JPG, JPEG, PNG</p>
                        <input type="file" name="coin_image" id="coin_image" class="file-input" accept="image/png, image/jpeg, image/jpg" onchange="previewImage()" />
                    </label>
                </div>
                <div id="preview-section" style="display: none; width: 100%;">
                    <div id="image-preview-container">
                        <img id="image-preview" src="" alt="Image Preview" />
                    </div>
                    <div id="buttons-container" class="buttons-group">
                        <button type="button" id="change-photo-btn" class="btn btn-secondary btn-icon" onclick="refreshPage()" title="New Upload">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button type="submit" id="classify-btn" class="btn btn-check btn-icon btn-disabled" disabled title="Classify Image">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
            </form>

            <div id="results" class="results-container {{ 'unclassified' if not coin_counts else '' }}" style="display: {{ 'block' if image_data_uri else 'none' }};">
                {% if bounding_boxes %}
                <div class="toggle-switch">
                    <span>Show Bounding Boxes</span>
                    <input type="checkbox" id="bounding-box-toggle" checked />
                    <label for="bounding-box-toggle">Toggle</label>
                </div>
                {% endif %}
                <div class="result-image-container">
                    <img id="result-image" src="{{ image_data_uri|default('') }}" alt="Classified Image" class="{{ 'result-image-hidden' if not image_data_uri }}" onclick="showPreviewModal(this.src)" style="cursor: pointer;" />
                    <div id="bounding-box-overlay"></div>
                </div>
                {% if not coin_counts and image_data_uri %}
                <div class="unclassified-message">
                    <i class="fas fa-info-circle"></i> No coins were detected in this image.
                </div>
                {% endif %}
                <div class="coin-group">
                    <div class="coin-row">
                        <div class="coin-card">
                            <div class="coin-value">1<span class="peso-sign">₱</span></div>
                            <span class="coin-count" id="coin-count-1">{{ (coin_counts|default({})).get('1', 0) }} coin{{ 's' if (coin_counts|default({})).get('1', 0) != 1 else '' }}</span>
                        </div>
                        <div class="coin-card">
                            <div class="coin-value">5<span class="peso-sign">₱</span></div>
                            <span class="coin-count" id="coin-count-5">{{ (coin_counts|default({})).get('5', 0) }} coin{{ 's' if (coin_counts|default({})).get('5', 0) != 1 else '' }}</span>
                        </div>
                    </div>
                    <div class="coin-row">
                        <div class="coin-card">
                            <div class="coin-value">10<span class="peso-sign">₱</span></div>
                            <span class="coin-count" id="coin-count-10">{{ (coin_counts|default({})).get('10', 0) }} coin{{ 's' if (coin_counts|default({})).get('10', 0) != 1 else '' }}</span>
                        </div>
                        <div class="coin-card">
                            <div class="coin-value">20<span class="peso-sign">₱</span></div>
                            <span class="coin-count" id="coin-count-20">{{ (coin_counts|default({})).get('20', 0) }} coin{{ 's' if (coin_counts|default({})).get('20', 0) != 1 else '' }}</span>
                        </div>
                    </div>
                </div>
                <div class="total-amount">
                    Total Amount: {{ total_amount|default('0') }} ₱
                </div>
                <div class="conversion-grid">
                    <div class="conversion-item" onclick="showConversionModal('USD', 0.018, '$')">
                        <div class="conversion-label">USD</div>
                        <div class="conversion-value">${{ "%.2f"|format((total_amount|default(0)|float) * 0.018) }}</div>
                    </div>
                    <div class="conversion-item" onclick="showConversionModal('JPY', 2.7, '¥')">
                        <div class="conversion-label">JPY</div>
                        <div class="conversion-value">¥{{ "%.0f"|format((total_amount|default(0)|float) * 2.7) }}</div>
                    </div>
                    <div class="conversion-item" onclick="showConversionModal('EUR', 0.016, '€')">
                        <div class="conversion-label">EUR</div>
                        <div class="conversion-value">€{{ "%.2f"|format((total_amount|default(0)|float) * 0.016) }}</div>
                    </div>
                    <div class="conversion-item" onclick="showConversionModal('GBP', 0.014, '£')">
                        <div class="conversion-label">GBP</div>
                        <div class="conversion-value">£{{ "%.2f"|format((total_amount|default(0)|float) * 0.014) }}</div>
                    </div>
                </div>
                
                {% if coin_counts %}
                <div style="margin-top: 22px; width: 100%;">
                    <button id="upload-again-btn" class="btn" onclick="resetAndUpload()">
                        <i class="fas fa-upload"></i> Upload Again
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="footer-name">Bern Vein Balermo</div>
        <div class="footer-course">Graphics and Visual Computing</div>
        <div>Philippine Coin Classifier &copy; 2025 | AI-Powered Coin Recognition</div>
    </div>

    <!-- No Coins Detected Modal -->
    <div id="noCoinsModal" class="modal">
        <div class="modal-content">
            <i class="fas fa-exclamation-circle modal-icon"></i>
            <h2 class="modal-title">No Coins Detected</h2>
            <p class="modal-message">We couldn't detect any coins in the image. Please try again with a clearer image of Philippine coins.</p>
            <button class="modal-btn" onclick="closeModal()">Try Again</button>
        </div>
    </div>

    <!-- Invalid Image Modal -->
    <div id="invalidImageModal" class="modal">
        <div class="modal-content">
            <i class="fas fa-image modal-icon" style="color: #ff6b6b;"></i>
            <h2 class="modal-title">Invalid Image</h2>
            <p class="modal-message">We couldn't recognize any valid Philippine coins in this image. Please upload a clear photo of Philippine coins.</p>
            <button class="modal-btn" onclick="closeInvalidImageModal()">Try Another Image</button>
        </div>
    </div>

    <!-- No Detections Modal -->
    <div id="noDetectionsModal" class="modal">
        <div class="modal-content">
            <i class="fas fa-search modal-icon" style="color: #ff9f43;"></i>
            <h2 class="modal-title">No Coins Detected</h2>
            <p class="modal-message">No coins were detected in this image. Please upload a clearer image with Philippine coins.</p>
            <button class="modal-btn" onclick="closeNoDetectionsModal()">Try Again</button>
        </div>
    </div>
    
    <!-- Error Modal -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <i class="fas fa-exclamation-triangle modal-icon" style="color: #ff6b6b;"></i>
            <h2 class="modal-title">Error</h2>
            <p id="errorMessage" class="modal-message">An error occurred while processing your request.</p>
            <button class="modal-btn" onclick="closeErrorModal()">OK</button>
        </div>
    </div>

    <!-- Currency Conversion Modal -->
    <div id="conversionModal" class="modal conversion-modal">
        <div class="modal-content">
            <i class="fas fa-exchange-alt modal-icon"></i>
            <h2 class="modal-title">Currency Conversion</h2>
            <div class="conversion-details">
                <div id="conversionRate" class="conversion-rate"></div>
                <div id="conversionExample" class="conversion-example"></div>
            </div>
            <button class="modal-btn" onclick="closeConversionModal()">Close</button>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="previewModal" class="preview-modal" onclick="closePreviewModal()">
        <img id="previewModalImage" src="" alt="Preview" />
        <div id="previewModalOverlay" class="preview-modal-overlay"></div>
    </div>

    <script>
        // Initialize coin counts from template
        const coinCounts = JSON.parse('{{ coin_counts|tojson|safe if coin_counts else "{}" }}');
        
        {% if bounding_boxes %}
        // Initialize bounding boxes
        const boundingBoxes = JSON.parse('{{ bounding_boxes|safe }}');
        const imageWidth = parseInt('{{ image_width }}');
        const imageHeight = parseInt('{{ image_height }}');
        {% endif %}
        
        // Check for detection status and show relevant modals
        document.addEventListener("DOMContentLoaded", function() {
            {% if error_message %}
            // Show error modal
            document.getElementById('errorMessage').textContent = "{{ error_message }}";
            document.getElementById('errorModal').style.display = 'flex';
            {% elif has_detections is defined and not has_detections %}
            // Show no detections modal
            document.getElementById('noDetectionsModal').style.display = 'flex';
            {% elif valid_detections is defined and not valid_detections %}
            // Show invalid image modal (detections exist but no valid coins)
            document.getElementById('invalidImageModal').style.display = 'flex';
            {% endif %}
        });

        function previewImage() {
            var file = document.getElementById("coin_image").files[0];
            var classifyBtn = document.getElementById("classify-btn");
            var uploadArea = document.getElementById("upload-area");
            var previewSection = document.getElementById("preview-section");
            var imgPreview = document.getElementById("image-preview");
            
            if (file) {
                classifyBtn.classList.remove("btn-disabled");
                classifyBtn.disabled = false;
                var reader = new FileReader();
                reader.onloadend = function() {
                    imgPreview.src = reader.result;
                    imgPreview.style.display = "block";
                    uploadArea.classList.add("upload-area-hidden");
                    previewSection.style.display = "block";
                }
                reader.readAsDataURL(file);
            } else {
                classifyBtn.classList.add("btn-disabled");
                classifyBtn.disabled = true;
                imgPreview.style.display = "none";
                previewSection.style.display = "none";
                uploadArea.classList.remove("upload-area-hidden");
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            // Handle form submission
            const uploadForm = document.getElementById("upload-form");
            if (uploadForm) {
                // Make sure the upload area is visible initially if no image data uri exists
                if (!('{{ image_data_uri }}')) {
                    document.getElementById("upload-area").classList.remove("upload-area-hidden");
                }
                
                uploadForm.addEventListener("submit", function(e) {
                    e.preventDefault();
                    if (document.getElementById("coin_image").files.length > 0) {
                        // Hide upload area before submitting
                        document.getElementById("upload-area").classList.add("upload-area-hidden");
                        // Hide the form itself
                        this.classList.add("upload-area-hidden");
                        this.submit();
                    } else {
                        showNoCoinsModal();
                    }
                });
            }

            const dropArea = document.querySelector('.upload-container');
            if (dropArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, unhighlight, false);
                });

                function highlight() {
                    dropArea.classList.add('highlight');
                }

                function unhighlight() {
                    dropArea.classList.remove('highlight');
                }

                dropArea.addEventListener('drop', handleDrop, false);

                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    if (files.length) {
                        document.getElementById('coin_image').files = files;
                        previewImage();
                    }
                }
            }

            // Update coin display on page load
            if (Object.keys(coinCounts).length > 0) {
                updateCoinDisplay();
            }
        });

        function showNoCoinsModal() {
            document.getElementById('noCoinsModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('noCoinsModal').style.display = 'none';
        }

        function showInvalidImageModal() {
            document.getElementById('invalidImageModal').style.display = 'flex';
        }

        function closeInvalidImageModal() {
            document.getElementById('invalidImageModal').style.display = 'none';
        }
        
        function closeNoDetectionsModal() {
            document.getElementById('noDetectionsModal').style.display = 'none';
        }
        
        function closeErrorModal() {
            document.getElementById('errorModal').style.display = 'none';
        }

        function showConversionModal(currency, rate, symbol) {
            const modal = document.getElementById('conversionModal');
            const rateElement = document.getElementById('conversionRate');
            const exampleElement = document.getElementById('conversionExample');
            
            rateElement.textContent = `1 ₱ = ${symbol}${rate.toFixed(4)}`;
            exampleElement.textContent = `${symbol}1 = ₱${(1/rate).toFixed(2)}`;
            
            modal.style.display = 'flex';
        }

        function closeConversionModal() {
            document.getElementById('conversionModal').style.display = 'none';
        }

        function showPreviewModal(src) {
            const modal = document.getElementById('previewModal');
            const modalImg = document.getElementById('previewModalImage');
            modal.style.display = 'block';
            modalImg.src = src;
            
            // Only draw bounding boxes in preview if they're currently visible
            const toggle = document.getElementById('bounding-box-toggle');
            if (toggle && toggle.checked) {
                // Wait for the image to load before drawing boxes
                modalImg.onload = function() {
                    setTimeout(function() {
                        drawPreviewModalBoxes();
                    }, 100);
                };
            }
        }

        function closePreviewModal() {
            document.getElementById('previewModal').style.display = 'none';
            // Clear the preview modal overlay
            document.getElementById('previewModalOverlay').innerHTML = '';
        }
        
        // Draw bounding boxes in the preview modal
        function drawPreviewModalBoxes() {
            {% if bounding_boxes %}
            const modalImg = document.getElementById('previewModalImage');
            const overlay = document.getElementById('previewModalOverlay');
            
            if (!modalImg || modalImg.naturalWidth === 0) {
                return;
            }
            
            overlay.innerHTML = ''; // Clear existing boxes
            
            const rect = modalImg.getBoundingClientRect();
            
            // Set overlay size to match image
            overlay.style.width = rect.width + 'px';
            overlay.style.height = rect.height + 'px';
            
            // Calculate scale ratio for the preview modal
            const scaleX = rect.width / imageWidth;
            const scaleY = rect.height / imageHeight;
            
            // Filter overlapping boxes, keeping only the one with highest confidence
            const filteredBoxes = filterOverlappingBoxes(boundingBoxes);
            
            for (const boxData of filteredBoxes) {
                const [x1, y1, x2, y2] = boxData.box;
                const value = boxData.value;
                const confidence = boxData.confidence;
                const className = boxData.class;
                
                // Create bounding box element
                const box = document.createElement('div');
                box.className = `bounding-box class-${value}`;
                box.style.left = (x1 * scaleX) + 'px';
                box.style.top = (y1 * scaleY) + 'px';
                box.style.width = ((x2 - x1) * scaleX) + 'px';
                box.style.height = ((y2 - y1) * scaleY) + 'px';
                
                // Create label
                const label = document.createElement('div');
                label.className = 'bounding-box-label';
                // Show coin value and side (front/back)
                const side = className.includes('Back') ? 'Back' : 'Front';
                label.textContent = `${value}₱ (${side}, ${(confidence * 100).toFixed(0)}%)`;
                label.style.backgroundColor = getComputedStyle(box).borderColor;
                
                box.appendChild(label);
                overlay.appendChild(box);
            }
            {% endif %}
        }

        function resetAndUpload() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/png, image/jpeg, image/jpg';
            fileInput.onchange = function(e) {
                if (e.target.files.length > 0) {
                    // Create and submit a new form
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.enctype = 'multipart/form-data';
                    
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.name = 'coin_image';
                    input.files = e.target.files;
                    
                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                }
            };
            fileInput.click();
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const noCoinsModal = document.getElementById('noCoinsModal');
            const conversionModal = document.getElementById('conversionModal');
            const previewModal = document.getElementById('previewModal');
            const invalidImageModal = document.getElementById('invalidImageModal');
            const noDetectionsModal = document.getElementById('noDetectionsModal');
            const errorModal = document.getElementById('errorModal');
            if (event.target == noCoinsModal) {
                closeModal();
            }
            if (event.target == conversionModal) {
                closeConversionModal();
            }
            if (event.target == previewModal) {
                closePreviewModal();
            }
            if (event.target == invalidImageModal) {
                closeInvalidImageModal();
            }
            if (event.target == noDetectionsModal) {
                closeNoDetectionsModal();
            }
            if (event.target == errorModal) {
                closeErrorModal();
            }
        }

        // Function to update coin display
        function updateCoinDisplay() {
            if (coinCounts) {
                document.getElementById('coin-count-1').textContent = `${coinCounts['1'] || 0} coin${(coinCounts['1'] || 0) !== 1 ? 's' : ''}`;
                document.getElementById('coin-count-5').textContent = `${coinCounts['5'] || 0} coin${(coinCounts['5'] || 0) !== 1 ? 's' : ''}`;
                document.getElementById('coin-count-10').textContent = `${coinCounts['10'] || 0} coin${(coinCounts['10'] || 0) !== 1 ? 's' : ''}`;
                document.getElementById('coin-count-20').textContent = `${coinCounts['20'] || 0} coin${(coinCounts['20'] || 0) !== 1 ? 's' : ''}`;
                
                // Check if all coin counts are zero
                const totalCoins = (coinCounts['1'] || 0) + (coinCounts['5'] || 0) + (coinCounts['10'] || 0) + (coinCounts['20'] || 0);
                if (totalCoins === 0 && '{{ image_data_uri }}') {
                    showInvalidImageModal();
                }
            }
        }

        // Function to refresh the page and clear all states
        function refreshPage() {
            window.location.href = window.location.pathname;
        }

        {% if bounding_boxes %}
        // Function to draw bounding boxes
        function drawBoundingBoxes() {
            const overlay = document.getElementById('bounding-box-overlay');
            const img = document.getElementById('result-image');
            
            if (!img || img.naturalWidth === 0) {
                // Image not loaded yet
                return;
            }
            
            overlay.innerHTML = ''; // Clear existing boxes
            
            const rect = img.getBoundingClientRect();
            
            // Set overlay to match exact image dimensions and position
            overlay.style.width = rect.width + 'px';
            overlay.style.height = rect.height + 'px';
            overlay.style.left = (img.offsetLeft) + 'px';
            overlay.style.top = (img.offsetTop) + 'px';
            
            // Calculate scale ratio to adjust bounding box positions
            const scaleX = rect.width / imageWidth;
            const scaleY = rect.height / imageHeight;

            // Filter overlapping boxes, keeping only the one with highest confidence
            const filteredBoxes = filterOverlappingBoxes(boundingBoxes);
            
            for (const boxData of filteredBoxes) {
                const [x1, y1, x2, y2] = boxData.box;
                const value = boxData.value;
                const confidence = boxData.confidence;
                const className = boxData.class;
                
                // Create bounding box element
                const box = document.createElement('div');
                box.className = `bounding-box class-${value}`;
                box.style.left = (x1 * scaleX) + 'px';
                box.style.top = (y1 * scaleY) + 'px';
                box.style.width = ((x2 - x1) * scaleX) + 'px';
                box.style.height = ((y2 - y1) * scaleY) + 'px';
                
                // Create label
                const label = document.createElement('div');
                label.className = 'bounding-box-label';
                // Show coin value and side (front/back)
                const side = className.includes('Back') ? 'Back' : 'Front';
                label.textContent = `${value}₱ (${side}, ${(confidence * 100).toFixed(0)}%)`;
                label.style.backgroundColor = getComputedStyle(box).borderColor;
                
                box.appendChild(label);
                overlay.appendChild(box);
            }
            
            console.log('Bounding boxes drawn', overlay.style.width, overlay.style.height);
        }

        // Calculate the intersection over union (IoU) of two bounding boxes
        function calculateIoU(box1, box2) {
            // Get coordinates
            const [x1min, y1min, x1max, y1max] = box1;
            const [x2min, y2min, x2max, y2max] = box2;
            
            // Calculate intersection area
            const xOverlap = Math.max(0, Math.min(x1max, x2max) - Math.max(x1min, x2min));
            const yOverlap = Math.max(0, Math.min(y1max, y2max) - Math.max(y1min, y2min));
            const intersectionArea = xOverlap * yOverlap;
            
            // Calculate union area
            const box1Area = (x1max - x1min) * (y1max - y1min);
            const box2Area = (x2max - x2min) * (y2max - y2min);
            const unionArea = box1Area + box2Area - intersectionArea;
            
            // Calculate IoU
            return intersectionArea / unionArea;
        }
        
        // Filter overlapping boxes, keeping only the one with highest confidence
        function filterOverlappingBoxes(boxes) {
            if (!boxes || boxes.length <= 1) return boxes;
            
            const filteredBoxes = [];
            const processedIndices = new Set();
            
            // IoU threshold for determining significant overlap
            const overlapThreshold = 0.5;
            
            for (let i = 0; i < boxes.length; i++) {
                if (processedIndices.has(i)) continue;
                
                let highestConfIdx = i;
                let highestConf = boxes[i].confidence;
                
                for (let j = i + 1; j < boxes.length; j++) {
                    if (processedIndices.has(j)) continue;
                    
                    // Calculate overlap
                    const iou = calculateIoU(boxes[i].box, boxes[j].box);
                    
                    if (iou > overlapThreshold) {
                        // These boxes overlap significantly
                        processedIndices.add(j);
                        
                        // Keep track of the box with highest confidence
                        if (boxes[j].confidence > highestConf) {
                            highestConfIdx = j;
                            highestConf = boxes[j].confidence;
                        }
                    }
                }
                
                // Add the box with highest confidence to filtered list
                processedIndices.add(highestConfIdx);
                filteredBoxes.push(boxes[highestConfIdx]);
            }
            
            return filteredBoxes;
        }
        
        // Setup toggle behavior
        document.addEventListener('DOMContentLoaded', function() {
            const toggle = document.getElementById('bounding-box-toggle');
            if (toggle) {
                // Draw bounding boxes initially since toggle is checked by default
                drawBoundingBoxes();
                document.getElementById('bounding-box-overlay').style.display = 'block';
                
                toggle.addEventListener('change', function() {
                    const overlay = document.getElementById('bounding-box-overlay');
                    if (this.checked) {
                        drawBoundingBoxes();
                        overlay.style.display = 'block';
                    } else {
                        overlay.style.display = 'none';
                    }
                });
                
                // Handle window resize
                window.addEventListener('resize', function() {
                    if (toggle.checked) {
                        drawBoundingBoxes();
                    }
                });
                
                // Handle image load event to ensure boxes are drawn after image is loaded
                const img = document.getElementById('result-image');
                if (img) {
                    img.addEventListener('load', function() {
                        if (toggle.checked) {
                            setTimeout(drawBoundingBoxes, 100); // Small delay to ensure image is fully rendered
                        }
                    });
                }
            }
        });
        {% endif %}
    </script>
</body>
</html>
